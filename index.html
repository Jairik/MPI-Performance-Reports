<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>MPI Performance Analysis</title>
	<script src="https://cdn.tailwindcss.com"></script>  <!-- Include tailwind css -->
	<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script> <!-- Include the plotly library -->
	<script>
		tailwind.config = {
			theme: {
				extend: {
					colors: {
						panel: '#111827',
						panelBorder: '#1f2937',
						muted: '#9ca3af',
					}
				}
			}
		};
	</script>
</head>

<body class="min-h-screen bg-slate-950 text-slate-50">
	<main class="mx-auto flex max-w-5xl flex-col gap-6 px-4 py-8">
		<header class="border-b border-slate-800 pb-4">
			<h1 class="text-3xl font-semibold text-white">MPI Performance Analysis</h1>
			<p class="mt-1 text-sm text-muted italic">by JJ McCauley</p>
			<p class="mt-1 text-sm text-muted text-center">Select the number of cores to test and the argument to test, then press "Update" to
				see the results.</p>
		</header>

		<section aria-labelledby="inputs-heading"
			class="rounded-2xl border border-panelBorder bg-panel/80 p-6 shadow-lg shadow-black/30">
			<div class="flex items-center justify-between gap-4">
				<h2 id="inputs-heading" class="text-xl font-semibold text-white">Inputs</h2>
				<button id="refresh"
					class="inline-flex items-center gap-2 rounded-lg bg-sky-500 px-4 py-2 text-sm font-semibold text-white transition hover:bg-sky-400 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300">
					<span>Analyze</span>
				</button>
			</div>
			<div class="mt-4 grid gap-5 md:grid-cols-2 md:items-end">
				<div class="flex flex-col gap-2">
					<label for="arguments" class="text-sm font-medium text-slate-200">Arguments</label>
					<input id="arguments" name="arguments" type="text" value="1000000000" placeholder="e.g. 1000000000"
						class="w-full rounded-lg border border-panelBorder bg-slate-900/60 px-3 py-2 text-sm text-white placeholder:text-muted focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-500/50" />
					<p class="text-xs text-muted">Runtime arguments passed to the analysis.</p>

					<label for="filename" class="text-sm font-medium text-slate-200">C source file</label>
					<input id="filename" name="filename" type="text" value="summation.c" placeholder="e.g. summation.c"
						class="w-full rounded-lg border border-panelBorder bg-slate-900/60 px-3 py-2 text-sm text-white placeholder:text-muted focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-500/50" />
					<p class="text-xs text-muted">Provide a .c filename to analyze.</p>
				</div>
				<div class="flex flex-col gap-2">
					<label for="cores" class="text-sm font-medium text-slate-200">Number of cores</label>
					<div id="cores" role="group" aria-describedby="cores-help"
						class="flex flex-wrap gap-2 rounded-lg border border-panelBorder bg-slate-900/60 p-3">
						<p class="text-sm text-muted">Loading core options…</p>
					</div>
					<p id="cores-help" class="text-xs text-muted">Click to toggle one or more core counts (defaults: 1, 2, 8).</p>
				</div>
			</div>
			<span id="status" class="mt-4 inline-block text-sm text-muted" role="status" aria-live="polite"></span>
		</section>

		<section aria-labelledby="graph-heading"
			class="rounded-2xl border border-panelBorder bg-panel/80 p-6 shadow-lg shadow-black/30">
			<h2 id="graph-heading" class="text-xl font-semibold text-white">Graph</h2>
			<p class="mt-1 text-sm text-muted">Interactive graph, hover over to pan/zoom/view.</p>
			<div id="graph"
				class="mt-4 min-h-[260px] overflow-auto rounded-xl border border-panelBorder bg-slate-900/60 p-4">
				<!-- JS will fill in the graph here -->
				<p class="text-sm text-muted">Waiting for data…</p>
			</div>
		</section>

		<section aria-labelledby="analysis-heading"
			class="rounded-2xl border border-panelBorder bg-panel/80 p-6 shadow-lg shadow-black/30">
			<h2 id="analysis-heading" class="text-xl font-semibold text-white">Analysis</h2>
			<!-- Single container that will be populated dynamically by JavaScript -->
			<div id="analysis" class="mt-4 min-h-[160px] rounded-xl border border-panelBorder bg-slate-900/60 p-4">
				<p class="text-sm text-muted">Waiting for analysis…</p>
			</div>
		</section>
	</main>

	<script>
		// API endpoint configuration
		const API = {
			systemCores: '/api/cores',  // Available core counts as JSON
			analysis: '/api/analysis',  // Analysis as JSON
		};

		// Hold all elements in a list for easy reference
		const elements = {
			arguments: document.getElementById('arguments'),
			filename: document.getElementById('filename'),
			cores: document.getElementById('cores'),
			graph: document.getElementById('graph'),
			status: document.getElementById('status'),
			analysis: document.getElementById('analysis'),
			refresh: document.getElementById('refresh'),
		};

		// Helper to render the graph content inside a sandboxed iframe
		function renderHtmlInIframe(container, html, heightPx = 520) {
			const iframe = document.createElement('iframe');
			iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin');
			iframe.style.width = '100%';
			iframe.style.height = `${heightPx}px`;
			iframe.style.border = '0';
			// Use srcdoc so the inline scripts inside the Plotly HTML run
			iframe.srcdoc = `<!doctype html><html><head><meta charset="utf-8"></head><body>${html}</body></html>`;
			container.innerHTML = '';
			container.appendChild(iframe);
		}

		function setStatus(msg) {
			elements.status.textContent = msg || '';
		}

		// Helper to fetch JSON data from an endpoint
		async function fetchJSON(url) {
			const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
			if (!res.ok) throw new Error(`Request failed: ${res.status}`);
			return await res.json();
		}

		// Get selected core values from the select element
		function getSelectedCores() {
			return Array.from(elements.cores.querySelectorAll('input[type="checkbox"]:checked')).map((el) => el.value);
		}

		// Populate the cores select element with options
		function populateCoresSelect(values) {
			const container = elements.cores;
			container.innerHTML = '';

			const defaults = new Set(['1', '2', '8']);
			const seen = new Set();
			const normalized = [];

			if (Array.isArray(values) && values.length) {
				for (const entry of values) {
					let value = entry;
					let label = entry;
					if (entry && typeof entry === 'object') {
						value = entry.value ?? entry.id ?? entry.cores ?? entry.name ?? entry;
						label = entry.label ?? entry.title ?? value;
					}
					if (value === undefined || value === null) continue;
					const valStr = String(value);
					if (seen.has(valStr)) continue;
					seen.add(valStr);
					normalized.push({ value: valStr, label: String(label ?? valStr) });
				}
			}

			if (!normalized.length) {
				['1', '2', '4', '8'].forEach((val) => {
					if (seen.has(val)) return;
					seen.add(val);
					normalized.push({ value: val, label: val });
				});
			}

			for (const def of defaults) {
				if (seen.has(def)) continue;
				seen.add(def);
				normalized.push({ value: def, label: def });
			}

			for (const { value, label } of normalized) {
				const checkboxId = `core-${value}`.replace(/[^a-z0-9_-]/gi, '-');
				const wrapper = document.createElement('label');
				wrapper.className = 'flex items-center gap-2 rounded-lg border border-panelBorder bg-slate-950/60 px-3 py-2 text-sm text-white transition hover:border-sky-400 focus-within:border-sky-400 focus-within:ring-2 focus-within:ring-sky-500/40';

				const input = document.createElement('input');
				input.type = 'checkbox';
				input.id = checkboxId;
				input.value = value;
				input.className = 'h-4 w-4 accent-sky-500 focus:outline-none';
				if (defaults.has(value)) input.checked = true;

				const span = document.createElement('span');
				span.className = 'font-medium text-slate-100';
				span.textContent = label;

				wrapper.appendChild(input);
				wrapper.appendChild(span);
				container.appendChild(wrapper);
			}
		}

		// Load available core options from the API
		async function loadCores() {
			try {
				const data = await fetchJSON(API.systemCores);
				let values = [];
				if (Array.isArray(data)) {
					values = data;
				} else if (Array.isArray(data?.options)) {
					values = data.options;
				} else if (Array.isArray(data?.cores)) {
					values = data.cores;
				} else if (typeof data?.cores === 'number') {
					values = Array.from({ length: Math.max(1, data.cores) }, (_, i) => i + 1);
				} else if (typeof data === 'number') {
					values = Array.from({ length: Math.max(1, data) }, (_, i) => i + 1);
				}
				populateCoresSelect(values);
			} catch (e) {
				// Graceful fallback
				populateCoresSelect([1, 2, 4, 8]);
				setStatus('Using default core options (endpoint unavailable).');
			}
		}

		// Load analysis statements from the API
		async function loadAnalysis() {
			elements.analysis.innerHTML = '<p class="text-sm text-muted">Loading analysis…</p>';
			elements.graph.innerHTML = '<p class="text-sm text-muted">Loading graph…</p>';

			// small helpers
			const toNumber = (v, d = 0) => (typeof v === 'number' ? v : Number(v ?? d));
			const rankNum = (k) => {
				if (Number.isInteger(k)) return k;
				const m = String(k).match(/rank\s*(\d+)/i);
				return m ? Number(m[1]) : Number.POSITIVE_INFINITY;
			};

			try {
				// Gather inputs from the form
				const file = elements.filename.value.trim();
				const args = elements.arguments.value.trim();
				const cores = getSelectedCores().map(Number);

				if (!cores.length) {
					elements.analysis.innerHTML = '<p class="text-sm text-yellow-400">Please select at least one core configuration.</p>';
					elements.graph.innerHTML = '<p class="text-sm text-yellow-400">Please select cores to generate graph.</p>';
					return;
				}

				// Make the API call
				const res = await fetch(API.analysis, {
					method: 'POST',
					headers: {
						'Accept': 'application/json',
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({ filename: file, x: args, numP: cores })
				});
				
				if (!res.ok) {
					throw new Error(`Analysis request failed: ${res.status} ${res.statusText}`);
				}
				
				const data = await res.json();

				// Extract analyses array from response
				const analyses = Array.isArray(data?.analyses) ? data.analyses : [];
				
				if (!analyses.length) {
					elements.analysis.innerHTML = '<p class="text-sm text-muted">No analysis results returned.</p>';
					// Try to render graph even if no analyses
					const graphHtml = data?.graph ?? '';
					if (graphHtml && String(graphHtml).trim()) {
						renderHtmlInIframe(elements.graph, graphHtml, 520);
					} else {
						elements.graph.innerHTML = '<p class="text-sm text-muted">No graph returned.</p>';
					}
					return;
				}

				// Build the Analysis panel
				const wrapper = document.createElement('div');
				wrapper.className = 'space-y-4';

				analyses.forEach((run) => {
					const np = toNumber(run.num_processes);
					const speedup = toNumber(run.speedup);
					const efficiency = toNumber(run.efficiency);
					const fp = Math.min(1, Math.max(0, toNumber(run.fp))); // clamp [0,1]
					const fpPct = (fp * 100).toFixed(2);
					const serialPct = (100 - fp * 100).toFixed(2);

					// collect rank runtimes (accept 'rank N' keys or integer keys)
					const rankEntries = Object.entries(run)
						.filter(([k, v]) => (/^rank\s*\d+$/i.test(String(k)) || Number.isInteger(k)) && typeof v === 'number')
						.sort((a, b) => rankNum(a[0]) - rankNum(b[0]));

					// Card container
					const card = document.createElement('div');
					card.className = 'rounded-xl border border-panelBorder bg-slate-900/60 p-4';

					// Header
					const h = document.createElement('div');
					h.className = 'flex items-center justify-between';
					h.innerHTML = `
					<h3 class="text-lg font-semibold text-white">Processes: <span class="font-mono">${np}</span></h3>
				`;
					card.appendChild(h);

					// Metrics grid
					const grid = document.createElement('div');
					grid.className = 'mt-3 grid gap-3 sm:grid-cols-2 lg:grid-cols-4';
					grid.innerHTML = `
					<div class="rounded-lg border border-panelBorder p-3">
					<div class="text-xs text-muted">Speedup</div>
					<div class="text-base font-semibold">${speedup.toFixed(3)}</div>
					</div>
					<div class="rounded-lg border border-panelBorder p-3">
					<div class="text-xs text-muted">Efficiency</div>
					<div class="text-base font-semibold">${efficiency.toFixed(3)}</div>
					</div>
					<div class="rounded-lg border border-panelBorder p-3">
					<div class="text-xs text-muted">Parallel Fraction (fₚ)</div>
					<div class="text-base font-semibold">${fpPct}%</div>
					</div>
					<div class="rounded-lg border border-panelBorder p-3">
					<div class="text-xs text-muted">Serial Fraction (1−fₚ)</div>
					<div class="text-base font-semibold">${serialPct}%</div>
					</div>
				`;
					card.appendChild(grid);

					// Dropdown (per-rank runtimes)
					const details = document.createElement('details');
					details.className = 'mt-3 rounded-lg border border-panelBorder';
					const summary = document.createElement('summary');
					summary.className = 'cursor-pointer select-none px-3 py-2 text-sm font-medium text-slate-200';
					summary.textContent = 'Per-rank runtimes';
					details.appendChild(summary);

					const list = document.createElement('div');
					list.className = 'px-3 pb-3';
					if (rankEntries.length) {
						const ul = document.createElement('ul');
						ul.className = 'mt-2 space-y-1 text-sm';
						for (const [k, v] of rankEntries) {
							const li = document.createElement('li');
							li.className = 'font-mono text-slate-200';
							li.textContent = `rank ${rankNum(k)}: ${v.toFixed(6)} seconds`;
							ul.appendChild(li);
						}
						list.appendChild(ul);
					} else {
						list.innerHTML = '<p class="text-sm text-muted mt-2">No per-rank runtimes reported.</p>';
					}
					details.appendChild(list);
					card.appendChild(details);

					wrapper.appendChild(card);
				});

				// Replace analysis contents
				elements.analysis.replaceChildren(wrapper);

				// Update the main graph with the response graph content
				const last = analyses[analyses.length - 1];
				const graphHtml = data?.graph ?? last?.graph ?? '';
				if (graphHtml && String(graphHtml).trim()) {
					renderHtmlInIframe(elements.graph, graphHtml, 520);
				} else {
					elements.graph.innerHTML = '<p class="text-sm text-muted">No graph returned.</p>';
				}
			} catch (e) {
				console.error('Analysis error:', e);
				elements.analysis.innerHTML = `<p class="text-sm text-red-400">Could not load analysis: ${e.message}</p>`;
				elements.graph.innerHTML = '<p class="text-sm text-red-400">Graph unavailable due to error.</p>';
			}
		}

		// Helper to refresh all the data from all elements
		async function refreshAll() {
			setStatus('Updating…');
			await Promise.allSettled([loadAnalysis()]);
			setStatus('');
		}

		// Wire up events
		elements.refresh.addEventListener('click', (e) => {
			e.preventDefault();
			refreshAll();
		});

		// Initialize on page load
		(async function init() {
			await loadCores();
			await refreshAll();
		})();
	</script>
</body>

</html>