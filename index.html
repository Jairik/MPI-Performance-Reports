<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>MPI Performance Analysis</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<script>
			tailwind.config = {
				theme: {
					extend: {
						colors: {
							panel: '#111827',
							panelBorder: '#1f2937',
							muted: '#9ca3af',
						}
					}
				}
			};
		</script>
	</head>
	<body class="min-h-screen bg-slate-950 text-slate-50">
		<main class="mx-auto flex max-w-5xl flex-col gap-6 px-4 py-8">
			<header class="border-b border-slate-800 pb-4">
				<h1 class="text-3xl font-semibold text-white">MPI Performance Analysis</h1>
				<p class="mt-1 text-sm text-muted italic">by JJ McCauley</p>
				<p class="mt-1 text-sm text-muted text-center">Select the number of cores to test, then press "Update" to see the results.</p>
			</header>

			<section aria-labelledby="inputs-heading" class="rounded-2xl border border-panelBorder bg-panel/80 p-6 shadow-lg shadow-black/30">
				<div class="flex items-center justify-between gap-4">
					<h2 id="inputs-heading" class="text-xl font-semibold text-white">Inputs</h2>
					<button id="refresh" class="inline-flex items-center gap-2 rounded-lg bg-sky-500 px-4 py-2 text-sm font-semibold text-white transition hover:bg-sky-400 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-300">
						<span>Analyze</span>
					</button>
				</div>
				<div class="mt-4 grid gap-5 md:grid-cols-2 md:items-end">
					<div class="flex flex-col gap-2">
						<label for="filename" class="text-sm font-medium text-slate-200">C source file</label>
						<input id="filename" name="filename" type="text" value="summation.c" placeholder="e.g. summation.c" class="w-full rounded-lg border border-panelBorder bg-slate-900/60 px-3 py-2 text-sm text-white placeholder:text-muted focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-500/50" />
						<p class="text-xs text-muted">Provide a .c filename to analyze.</p>
					</div>
					<div class="flex flex-col gap-2">
						<label for="cores" class="text-sm font-medium text-slate-200">Number of cores</label>
						<select id="cores" name="cores" multiple size="5" aria-describedby="cores-help" class="h-32 w-full rounded-lg border border-panelBorder bg-slate-900/60 px-3 py-2 text-sm text-white focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-500/50">
							<option disabled>Loading core options…</option>
						</select>
						<p id="cores-help" class="text-xs text-muted">Select one or more (Ctrl/Cmd or Shift-click).</p>
					</div>
				</div>
				<span id="status" class="mt-4 inline-block text-sm text-muted" role="status" aria-live="polite"></span>
			</section>

			<section aria-labelledby="graph-heading" class="rounded-2xl border border-panelBorder bg-panel/80 p-6 shadow-lg shadow-black/30">
				<h2 id="graph-heading" class="text-xl font-semibold text-white">Graph</h2>
				<div id="graph" class="mt-4 min-h-[260px] overflow-auto rounded-xl border border-panelBorder bg-slate-900/60 p-4">
					<!-- JS will fill in the graph here -->
					<p class="text-sm text-muted">Waiting for data…</p>
				</div>
			</section>

			<section aria-labelledby="analysis-heading" class="rounded-2xl border border-panelBorder bg-panel/80 p-6 shadow-lg shadow-black/30">
				<h2 id="analysis-heading" class="text-xl font-semibold text-white">Analysis</h2>
				<!-- Single container that will be populated dynamically by JavaScript -->
				<div id="analysis" class="mt-4 min-h-[160px] rounded-xl border border-panelBorder bg-slate-900/60 p-4">
					<p class="text-sm text-muted">Waiting for analysis…</p>
				</div>
			</section>
		</main>

		<script>
			// API endpoint configuration
			const API = {
				systemCores: '/api/cores',  // Available core counts as JSON
				reportsGraph: '/api/graph',  // Performance graph as HTML
				analysis: '/api/analysis',  // Analysis as JSON
			};

			// Hold all elements in a list for easy reference
			const elements = {
				filename: document.getElementById('filename'),
				cores: document.getElementById('cores'),
				graph: document.getElementById('graph'),
				status: document.getElementById('status'),
				analysis: document.getElementById('analysis'),
				refresh: document.getElementById('refresh'),
			};

			function setStatus(msg) {
				elements.status.textContent = msg || '';
			}

			// Helper to fetch JSON data from an endpoint
			async function fetchJSON(url) {
				const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
				if (!res.ok) throw new Error(`Request failed: ${res.status}`);
				return await res.json();
			}

			// Get selected core values from the select element
			function getSelectedCores() {
				return Array.from(elements.cores.selectedOptions).map(o => o.value).filter(Boolean);
			}

			// Populate the cores select element with options
			function populateCoresSelect(values) {
				elements.cores.innerHTML = '';
				if (!values || !values.length) {
					const opt = document.createElement('option');
					opt.disabled = true; opt.textContent = 'No core options available';
					elements.cores.appendChild(opt);
					return;
				}
				for (const v of values) {
					let value = String(v.cores);
					const opt = document.createElement('option');
					opt.value = String(value);
					opt.textContent = String(value);
					elements.cores.appendChild(opt);
				}
			}

			// Load available core options from the API
			async function loadCores() {
				try {
					const data = await fetchJSON(API.systemCores);
					const values = Array.isArray(data) ? data : (Array.isArray(data.options) ? data.options : []);
					populateCoresSelect(values);
				} catch (e) {
					// Graceful fallback
					populateCoresSelect([1, 2, 4, 8]);
					setStatus('Using default core options (endpoint unavailable).');
				}
			}

			// Load and display the graph from the API
			async function loadGraph() {
				const file = elements.filename.value.trim();
				const cores = getSelectedCores();
				elements.graph.innerHTML = '<p class="muted">Loading graph…</p>';
				try {
					const url = new URL(API.reportsGraph, window.location.origin);
					if (file) url.searchParams.set('file', file);
					if (cores.length) url.searchParams.set('cores', cores.join(','));
					const res = await fetch(url.toString(), { headers: { 'Accept': 'text/html' } });
					if (!res.ok) throw new Error(`Graph request failed: ${res.status}`);
					const html = await res.text();
					elements.graph.innerHTML = html || '<p class="muted">No graph returned.</p>';
				} catch (e) {
					elements.graph.innerHTML = '<p class="muted">Could not load graph. Ensure the reports/graph endpoint is available.</p>';
				}
			}

			// Load analysis statements from the API
			async function loadAnalysis() {
				elements.analysis.innerHTML = '<p class="muted">Loading analysis…</p>';
				// NOTE: Looking at this now, it is not at all optimal. However it is good enough for now.
				
				// TODO: fetch analysis payload from API.analysis and render it into `elements.analysis`.
			}

			// Helper to refresh all the data from all elements
			async function refreshAll() {
				setStatus('Updating…');
				await Promise.allSettled([loadGraph(), loadAnalysis()]);
				setStatus('');
			}

			// Wire up events
			elements.refresh.addEventListener('click', (e) => {
				e.preventDefault();
				refreshAll();
			});

			// Initialize on page load
			(async function init() {
				await loadCores();
				// Select a simple default if present
				const firstTwo = Array.from(elements.cores.options).slice(0, 2);
				for (const o of firstTwo) o.selected = true;
				await refreshAll();
			})();
		</script>
	</body>
	</html>
